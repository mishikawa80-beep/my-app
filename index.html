<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="My Planner">
    <link rel="apple-touch-icon" href="icon.png">

    <title>Daily Success Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap');
        body {
            font-family: 'Inter', 'sans-serif', "Helvetica Neue", Arial, "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            background-color: #f8fafc;
            -webkit-tap-highlight-color: transparent;
            /* 上部のステータスバーとの重なりを防ぐための余白（iOSフルスクリーン用） */
            padding-top: env(safe-area-inset-top);
        }
        .task-card {
            transition: all 0.2s ease;
            touch-action: manipulation;
        }
        .task-card:active {
            transform: scale(0.98);
            background-color: #f1f5f9;
        }
        .completed {
            text-decoration: line-through;
            opacity: 0.6;
        }
        input[type="text"] {
            font-size: 16px !important;
        }
    </style>
</head>
<body class="p-4 md:p-8 pb-12">
    <div id="app" class="max-w-4xl mx-auto">
        <header class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div>
                <h1 id="currentDate" class="text-2xl md:text-3xl font-bold text-slate-800 tracking-tight">読み込み中...</h1>
                <p class="text-slate-500 text-sm md:text-base">今日も素晴らしい一日にしましょう。</p>
            </div>
            <div class="flex gap-3">
                <div class="bg-white p-2 md:p-3 rounded-xl shadow-sm border border-slate-200 text-center flex-1 md:min-w-[100px]">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">Daily</div>
                    <div id="dailyProgress" class="text-lg md:text-xl font-semibold text-blue-600">0%</div>
                </div>
                <div class="bg-white p-2 md:p-3 rounded-xl shadow-sm border border-slate-200 text-center flex-1 md:min-w-[100px]">
                    <div class="text-[10px] text-slate-400 uppercase font-bold">ToDo</div>
                    <div id="todoProgress" class="text-lg md:text-xl font-semibold text-purple-600">0%</div>
                </div>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
            <section class="bg-white/50 p-4 rounded-2xl border border-slate-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-slate-700 flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-blue-500 rounded-full"></span>
                        毎日やるタスク
                    </h2>
                    <span id="dailyCount" class="bg-blue-100 text-blue-700 px-2 py-0.5 rounded text-[10px] font-bold">0 items</span>
                </div>
                
                <div class="flex gap-2 mb-4">
                    <input type="text" id="dailyInput" placeholder="新しいルーチンを追加..." class="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-all bg-white">
                    <button onclick="addTask('daily')" class="bg-blue-500 hover:bg-blue-600 text-white w-12 h-12 rounded-xl transition-colors font-bold text-xl shadow-sm shadow-blue-200 flex items-center justify-center flex-shrink-0">+</button>
                </div>

                <div id="dailyList" class="space-y-3"></div>
            </section>

            <section class="bg-white/50 p-4 rounded-2xl border border-slate-100">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold text-slate-700 flex items-center gap-2">
                        <span class="w-1.5 h-5 bg-purple-500 rounded-full"></span>
                        To Do (繰り越し対応)
                    </h2>
                    <span id="todoCount" class="bg-purple-100 text-purple-700 px-2 py-0.5 rounded text-[10px] font-bold">0 items</span>
                </div>

                <div class="flex gap-2 mb-4">
                    <input type="text" id="todoInput" placeholder="新しいToDoを追加..." class="flex-1 px-4 py-3 rounded-xl border border-slate-200 focus:outline-none focus:ring-2 focus:ring-purple-500 transition-all bg-white">
                    <button onclick="addTask('todo')" class="bg-purple-500 hover:bg-purple-600 text-white w-12 h-12 rounded-xl transition-colors font-bold text-xl shadow-sm shadow-purple-200 flex items-center justify-center flex-shrink-0">+</button>
                </div>

                <div id="todoList" class="space-y-3"></div>
            </section>
        </div>

        <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800/95 text-white px-6 py-3 rounded-full shadow-xl opacity-0 pointer-events-none transition-all duration-300 text-sm backdrop-blur-sm z-50">
            メッセージ
        </div>
    </div>

    <script>
        let state = {
            dailyTasks: [],
            todoTasks: [],
            lastVisitDate: new Date().toLocaleDateString()
        };

        function loadData() {
            const saved = localStorage.getItem('dailyPlannerData');
            if (saved) {
                const parsed = JSON.parse(saved);
                state.dailyTasks = parsed.dailyTasks || [];
                state.todoTasks = parsed.todoTasks || [];
                
                const today = new Date().toLocaleDateString();
                if (parsed.lastVisitDate !== today) {
                    handleDateChange(parsed.lastVisitDate, today);
                }
                state.lastVisitDate = today;
            }
        }

        function save() {
            localStorage.setItem('dailyPlannerData', JSON.stringify(state));
            render();
        }

        function handleDateChange(lastDate, today) {
            state.dailyTasks = state.dailyTasks.map(task => ({ ...task, completed: false }));
            showToast("新しい一日です！ルーチンをリセットしました。");
        }

        function addTask(type) {
            const input = document.getElementById(type + 'Input');
            const text = input.value.trim();
            if (!text) return;

            const newTask = {
                id: Date.now(),
                text: text,
                completed: false,
                createdAt: new Date().toISOString()
            };

            if (type === 'daily') {
                state.dailyTasks.push(newTask);
            } else {
                state.todoTasks.push(newTask);
            }

            input.value = '';
            input.blur();
            save();
        }

        function toggleTask(type, id) {
            const list = type === 'daily' ? state.dailyTasks : state.todoTasks;
            const task = list.find(t => t.id === id);
            if (task) {
                task.completed = !task.completed;
                save();
            }
        }

        function deleteTask(type, id) {
            if (type === 'daily') {
                state.dailyTasks = state.dailyTasks.filter(t => t.id !== id);
            } else {
                state.todoTasks = state.todoTasks.filter(t => t.id !== id);
            }
            save();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.classList.remove('opacity-0');
            toast.classList.add('opacity-100');
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        }

        function render() {
            const dailyList = document.getElementById('dailyList');
            const todoList = document.getElementById('todoList');
            const today = new Date();
            
            // 今日の日付を反映
            document.getElementById('currentDate').innerText = `${today.getFullYear()}年${today.getMonth()+1}月${today.getDate()}日`;

            const renderItem = (task, type) => `
                <div class="task-card bg-white p-4 rounded-xl border border-slate-200 flex items-center justify-between shadow-sm">
                    <div class="flex items-center gap-4 cursor-pointer flex-1 py-1" onclick="toggleTask('${type}', ${task.id})">
                        <div class="w-6 h-6 rounded-${type === 'daily' ? 'full' : 'md'} border-2 ${type === 'daily' ? 'border-blue-400' : 'border-purple-400'} flex items-center justify-center flex-shrink-0 ${task.completed ? (type === 'daily' ? 'bg-blue-500 border-blue-500' : 'bg-purple-500 border-purple-500') : ''}">
                            ${task.completed ? '<svg class="w-4 h-4 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path></svg>' : ''}
                        </div>
                        <span class="${task.completed ? 'completed text-slate-400' : 'text-slate-700 font-medium'} text-base break-all">${task.text}</span>
                    </div>
                    <button onclick="deleteTask('${type}', ${task.id})" class="text-slate-300 hover:text-red-500 p-2 ml-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                </div>
            `;

            dailyList.innerHTML = state.dailyTasks.map(t => renderItem(t, 'daily')).join('') || '<p class="text-center text-slate-400 py-6 text-sm italic">ルーチンを登録しましょう</p>';
            todoList.innerHTML = state.todoTasks.map(t => renderItem(t, 'todo')).join('') || '<p class="text-center text-slate-400 py-6 text-sm italic">やるべきことを登録しましょう</p>';

            const updateStats = (list, progressId, countId) => {
                const comp = list.filter(t => t.completed).length;
                const total = list.length;
                const perc = total === 0 ? 0 : Math.round((comp / total) * 100);
                document.getElementById(progressId).innerText = perc + '%';
                document.getElementById(countId).innerText = `${total} items`;
            };

            updateStats(state.dailyTasks, 'dailyProgress', 'dailyCount');
            updateStats(state.todoTasks, 'todoProgress', 'todoCount');
        }

        document.getElementById('dailyInput').addEventListener('keypress', (e) => e.key === 'Enter' && addTask('daily'));
        document.getElementById('todoInput').addEventListener('keypress', (e) => e.key === 'Enter' && addTask('todo'));

        loadData();
        render();
    </script>
</body>
</html>
