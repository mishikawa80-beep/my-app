<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="icon.png">
    <title>Daily Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .counter-btn { width: 40px; height: 40px; display: flex; items-center; justify-content: center; border-radius: 50%; background: #e2e8f0; font-weight: bold; }
    </style>
</head>
<body class="p-4 max-w-md mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-slate-800">Daily Success Planner</h1>

    <div class="mb-8">
        <h2 class="text-lg font-semibold mb-3 text-blue-600">Daily Habit Counters</h2>
        <div id="habits" class="space-y-4">
            </div>
    </div>

    <div class="mb-8">
        <h2 class="text-lg font-semibold mb-3 text-green-600">Tasks</h2>
        <div class="flex mb-4">
            <input type="text" id="todoInput" class="border p-2 flex-grow rounded-l" placeholder="新しいタスク...">
            <button onclick="addTodo()" class="bg-green-500 text-white px-4 py-2 rounded-r">追加</button>
        </div>
        <ul id="todoList" class="space-y-2"></ul>
    </div>

    <script>
        // データ構造
        let state = {
            lastDate: new Date().toLocaleDateString(),
            habits: {
                'abceed': { count: 0, total: 0 },
                'Duolingo': { count: 0, total: 0 }
            },
            todos: []
        };

        // 保存と読み込み
        function save() { localStorage.setItem('plannerState', JSON.stringify(state)); }
        function load() {
            const saved = localStorage.getItem('plannerState');
            if (saved) {
                const loadedState = JSON.parse(saved);
                state = loadedState;
                checkDayPivot();
            }
            render();
        }

        // 日付が変わった時の処理
        function checkDayPivot() {
            const today = new Date().toLocaleDateString();
            if (state.lastDate !== today) {
                // 1. カウンターの集計とリセット
                for (let key in state.habits) {
                    let h = state.habits[key];
                    if (h.count > 0) {
                        h.total += h.count; // 継続成功：累計にプラス
                    } else {
                        h.total = 0; // 継続失敗：累計リセット
                    }
                    h.count = 0; // 今日の分は0に戻す
                }
                // 2. 完了済みToDoの削除
                state.todos = state.todos.filter(todo => !todo.done);
                
                state.lastDate = today;
                save();
            }
        }

        // カウンター操作
        function updateCount(key, delta) {
            state.habits[key].count = Math.max(0, state.habits[key].count + delta);
            save();
            render();
        }

        // ToDo操作
        function addTodo() {
            const input = document.getElementById('todoInput');
            if (!input.value) return;
            state.todos.push({ text: input.value, done: false });
            input.value = '';
            save();
            render();
        }

        function toggleTodo(index) {
            state.todos[index].done = !state.todos[index].done;
            save();
            render();
        }

        // 画面描画
        function render() {
            // カウンター描画
            const habitDiv = document.getElementById('habits');
            habitDiv.innerHTML = '';
            for (let key in state.habits) {
                const h = state.habits[key];
                habitDiv.innerHTML += `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100">
                        <div class="flex justify-between items-center mb-2">
                            <span class="font-bold text-slate-700">${key}</span>
                            <span class="text-xs text-slate-400 font-medium">累計: ${h.total}回</span>
                        </div>
                        <div class="flex items-center justify-between">
                            <button onclick="updateCount('${key}', -1)" class="counter-btn">-</button>
                            <span class="text-2xl font-black text-slate-800">${h.count}</span>
                            <button onclick="updateCount('${key}', 1)" class="counter-btn">+</button>
                        </div>
                    </div>`;
            }

            // ToDo描画
            const todoList = document.getElementById('todoList');
            todoList.innerHTML = '';
            state.todos.forEach((todo, i) => {
                todoList.innerHTML += `
                    <li onclick="toggleTodo(${i})" class="flex items-center bg-white p-3 rounded shadow-sm cursor-pointer border-l-4 ${todo.done ? 'border-gray-300 opacity-50' : 'border-green-400'}">
                        <input type="checkbox" ${todo.done ? 'checked' : ''} class="mr-3">
                        <span class="${todo.done ? 'line-through text-gray-400' : 'text-slate-700'}">${todo.text}</span>
                    </li>`;
            });
        }

        load();
    </script>
</body>
</html>
